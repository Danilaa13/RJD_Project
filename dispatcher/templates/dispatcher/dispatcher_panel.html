{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Диспетчерская панель - АС Заявочный ремонт</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{% static 'dispatcher/style.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/luxon@2.3.1/build/global/luxon.min.js"></script>

</head>
<body>
<div class="container">
    <header>
        <div>
            <h1>Диспетчерская панель</h1>
            <p style="margin-top: 10px;">АС Заявочный ремонт • Режим реального времени</p>
        </div>
        <div class="user-info">
            <div style="text-align: right;">
                <div class="user-name">{{ user.get_full_name|default:"Иванов И.И." }}</div>
                <div class="user-role">{{ user.profile.role|default:"Диспетчер" }}</div>
            </div>
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
        </div>
    </header>

    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-title">Всего заявок</div>
            <div class="stat-value">{{ stats.total }}</div>
            </div>
        <div class="stat-card">
            <div class="stat-title">В работе</div>
            <div class="stat-value">{{ stats.in_progress }}</div>
            </div>
        <div class="stat-card">
            <div class="stat-title">Выполнено</div>
            <div class="stat-value">{{ stats.done }}</div>
            </div>
        <div class="stat-card">
            <div class="stat-title">Срочные</div>
            <div class="stat-value">{{ stats.urgent }}</div>
            </div>
    </div>

    <div class="controls">
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="search" placeholder="Поиск по ФИО, поезду или вагону...">
        </div>
        <div class="filter-container">
            <select id="filter">
                <option value="all">Все заявки</option>
                <option value="new">Новые</option>
                <option value="assigned">В наряде</option>
                <option value="done">Выполнено</option>
                <option value="urgent">Срочные</option>
            </select>
        </div>
    </div>

    <div class="task-list" id="task-list">
        {% for req in requests %}
        <div class="task-card" data-status="{{ req.status }}" data-request-id="{{ req.id }}">
            <div class="task-header">
                <div class="task-title">Зафиксировал: {{ req.employee_fio }}</div>
                <div class="task-status status-{{ req.status }}">
                    {{ req.get_status_display }} </div>
            </div>
            <div class="task-info">
                <span class="label"><i class="fas fa-train"></i> Поезд:</span>
                <span class="value">{{ req.train_number }}</span>
            </div>
             <div class="task-info">
                 <span class="label"><i class="fas fa-hashtag"></i> Табель:</span>
                 <span class="value">{{ req.employee_tabel }}</span>
             </div>
            <div class="task-info">
                <span class="label"><i class="far fa-calendar-alt"></i> Дата создания:</span>
                <span class="value">{{ req.created_at|date:"d/m/Y H:i" }}</span> </div>
            {% if req.route %}
            <div class="task-info">
                <span class="label"><i class="fas fa-route"></i> Маршрут:</span>
                <span class="value">{{ req.route }}</span>
            </div>
            {% endif %}
            <div class="task-info">
                <span class="label"><i class="fas fa-box"></i> Вагон:</span>
                <span class="value">{{ req.wagon_number }}</span>
            </div>
            {% if req.location %}
            <div class="task-info">
                <span class="label"><i class="fas fa-map-marker-alt"></i> Пункт:</span>
                <span class="value">{{ req.location }}</span>
            </div>
             {% endif %}
             <div class="task-info">
                 <span class="label"><i class="fas fa-wrench"></i> Категория:</span>
                 <span class="value" title="{{ req.category_path }}">{{ req.fault_description }}</span> </div>
            <div class="task-info">
                <span class="label"><i class="fas fa-exclamation-triangle"></i> Код:</span>
                <span class="value">{{ req.classification_code }}</span>
            </div>

            {% if req.status != 'done' and req.deadline %}
            <div class="task-info">
                <span class="label"><i class="fas fa-clock"></i> Осталось:</span>
                <span class="value timer" data-deadline="{{ req.deadline.isoformat }}">
                    <i class="fas fa-hourglass-half"></i> <span class="time-value">Расчет...</span>
                </span>
            </div>
             {% elif req.status == 'done' %}
              <div class="task-info">
                  <span class="label"><i class="fas fa-check-circle"></i> Статус:</span>
                  <span class="value status-done-text">Ремонт завершен</span>
              </div>
             {% endif %}

            <div class="buttons">
                <button class="btn btn-status-update" data-new-status="done" {% if req.status == 'done' %}disabled{% endif %}>
                    <i class="fas fa-check"></i> Выполнено
                </button>
                <button class="btn btn-status-update" data-new-status="assigned" {% if req.status == 'assigned' or req.status == 'done' %}disabled{% endif %}>
                    <i class="fas fa-user-tag"></i> В наряд
                </button>
                 <button class="btn btn-status-update" data-new-status="urgent" {% if req.status == 'urgent' or req.status == 'done' %}disabled{% endif %}>
                    <i class="fas fa-star"></i> Срочно
                </button>
                <button class="btn btn-delete"><i class="fas fa-trash"></i></button>
                <button class="btn btn-more"><i class="fas fa-ellipsis-h"></i></button>
            </div>
        </div>
        {% empty %}
          <p>Нет доступных заявок.</p>
        {% endfor %}
    </div>
</div>

<script src="{% static 'dispatcher/script.js' %}"></script>

</body>
</html>